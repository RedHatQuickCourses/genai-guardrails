<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Custom Criteria Guardrails :: Guardrails for AI Applications</title>
    <link rel="prev" href="hap-lab.html">
    <link rel="next" href="../guardrails-ai/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Guardrails for AI Applications</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/genai-guardrails/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="genai-guardrails" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Guardrails for AI Applications</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../intro/index.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../intro/guardrails.html">Why Guardrails?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../intro/unguarded.html">Lab: LLMs with no Guardrails</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../intro/implementation.html">Implementing Guardrails</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">IBM Granite Guardian</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="intro.html">IBM Granite Guardian</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="simple.html">Lab: Input Guardrails</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="response.html">Lab: Output Guardrails</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hap.html">IBM HAP Models</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hap-lab.html">Lab: IBM HAP Models</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="custom.html">Lab: Custom Criteria Guardrails</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../guardrails-ai/index.html">Guardrails AI</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../guardrails-ai/intro.html">Introduction to Guardrails AI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../guardrails-ai/simple.html">Lab: Simple Guardrails</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../guardrails-ai/stacked.html">Lab: Stacking Multiple Validators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../guardrails-ai/fix.html">Lab: Redacting and Filtering Content</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../guardrails-ai/server.html">Lab: Guardrails AI Server</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../trusty-ai/index.html">Trusty AI (WIP)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../feedback/index.html">Feedback</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Guardrails for AI Applications</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Guardrails for AI Applications</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Guardrails for AI Applications</a></li>
    <li><a href="index.html">IBM Granite Guardian</a></li>
    <li><a href="custom.html">Lab: Custom Criteria Guardrails</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Custom Criteria Guardrails</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In the previous labs, you checked the <strong>input</strong> and <strong>output</strong> texts and verified the safety of them using the IBM Granite Guardian model.</p>
</div>
<div class="paragraph">
<p>In this lab, you will create your own custom guardrails criteria and verify if the user-entered query is safe. You will run the latest <code>ibm/granite3.3-guardian:8b</code> LLM model using <code>ollama</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We do not run any inference LLM model in this lab, and we restrict ourselves to checking inputs.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You need to use the latest IBM Granite Guardian 3.3-8B model (<code>ibm/granite3.3-guardian:8</code>) for this lab to work.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pre_requistes"><a class="anchor" href="#_pre_requistes"></a>Pre-requistes</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Python v3.12 or higher (The labs in this course were tested with Python 3.12 on macOS)</p>
</li>
<li>
<p>The <code>pip</code> CLI to install Python libraries</p>
</li>
<li>
<p>Git CLI to clone the sample code from GitHub</p>
</li>
<li>
<p>Visual Studio Code or other editors to edit Python code</p>
</li>
<li>
<p>ollama runtime to run the Guardian model (<code>ibm/granite3.3-guardian:8b</code>)</p>
<div class="ulist">
<ul>
<li>
<p>Install ollama for your platform and start it by following the instructions at <a href="https://ollama.com/download" class="bare">https://ollama.com/download</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_steps"><a class="anchor" href="#_steps"></a>Steps</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you have not already done it, clone the Git repository containing the code to a folder of your choice.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>git clone https://github.com/RedHatQuickCourses/genai-apps.git</strong></code></pre>
</div>
</div>
</li>
<li>
<p>All the code for IBM Granite Guardian is in a folder called <code>guardrails/granite-guardian</code>. Change to this folder in the terminal.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cd genai-apps/guardrails/granite-guardian</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Activate the virtual environment you created in the previous lab. If you have not created a virtual environment, refer to the previous lab to create it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>source venv/bin/activate</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Your prompt should change to indicate that you are now running in an isolated virtual environment.</p>
</div>
</li>
<li>
<p>If you have not done it previously, install all the needed dependencies using <code>pip install</code>. It will take some time to compile native libraries and install all the dependencies for your platform.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ (venv) <strong>pip install -r requirements.txt</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Pull the <code>ibm/granite3.3-guardian:8b</code> model using ollama. You must have installed and started the ollama service as outlined in the pre-requisites section. This model is around 7GB in size and will take a while to download depending on your internet connection speed.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ollama pull ibm/granite3.3-guardian:8b</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Inspect the <code>guardian-custom.py</code> file in the editor of your choice. The <code>main()</code> method tests different scenarios, where the mocked input from the user is checked for harmful content.</p>
<div class="paragraph">
<p>The <strong>default_config_test()</strong> method uses the default <strong>harm</strong> category and sends the user query to the Guardian model running on ollama. Note that we are customizing the prompt before sending to the Guardian by augmenting the chat template with the <strong>guardian_config</strong> dictionary, and passing the <code>harm</code> value to the <strong>criteria_id</strong> attribute (attribute name for setting risk category has changed from <code>content</code> to <code>criteria_id</code> in Guardian 3.3).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
def default_config_test(user_text, category):
    messages = [{"role": "user", "content": user_text}]

    guardian_config = {"criteria_id": <strong>category</strong>}

    chat = tokenizer.apply_chat_template(messages,
            <strong>guardian_config = guardian_config</strong>,
            tokenize=False, add_generation_prompt=True)

    response = guardian.invoke(chat).content
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the invocation in the <strong>main()</strong> method with the default <code>harm</code> category.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">default_config_test("How can I hack my friend's email?", **"harm"**)</code></pre>
</div>
</div>
</li>
<li>
<p>The next call in the <code>main</code> method sets the risk category as <code>unethical_behavior</code>, and this value is used to set the <code>criteria_id</code> in the <code>unethical_test()</code> method. The body of this method is similar to the <code>default_config_test()</code> method, with the <code>criteria_id</code> being set to <code>unethical_behavior</code> instead of the default.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">unethical_test("Is there a way to mirror or copy someone's hard drive, maybe without them knowing?", "unethical_behavior")</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The first two methods are just for demonstration purposes. They show that customizing the prompts using a chat template does not change the default behavior of the Guardian model.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Finally, explore the <code>custom_criteria_test()</code> method. We set a custom attribute called <code>custom_criteria</code> and set it to a multi-line string that defines in plain language what should be checked in the user query. In this case, we are checking if inputs (or outputs) contain any Personally Identifiable Information (PII) about users. This custom criteria is sent as a prompt to the Guardian model running on ollama, along with the raw unsanitized user query.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">def custom_criteria_test(user_text):
    messages = [{"role": "user", "content": user_text}]
    <strong>custom_criteria = """User message contains Personally Identifiable Information (PII) like bank accounts,
        addresses, email IDs or addresses, social security numbers (SSN), or other sensitive personal information that is included as a part of a prompt."""</strong>

    <strong>guardian_config = {"custom_criteria": custom_criteria}</strong>

    chat = tokenizer.apply_chat_template(messages, guardian_config = guardian_config, tokenize=False, add_generation_prompt=True)
    response = guardian.invoke(chat).content</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>guardian-custom.py</code> in the virtual environment.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ (venv) <strong>python guardian-custom.py</strong>
Guardian result for query &lt;How can I hack my friend's email?&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked

Guardian result for query &lt;Is there a way to mirror or copy someone's hard drive, maybe without them knowing?&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked

Guardian result for query &lt;Hi, you can use my SSN : 123-1234-1245.&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked</code></pre>
</div>
</div>
<div class="paragraph">
<p>All three test inputs are marked as unsafe by the Guardian model.</p>
</div>
</li>
<li>
<p>There are a few more commented-out methods in the file. Uncomment all of them and verify the output. Run the <code>guardian-custom.py</code> in the virtual environment once again.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ (venv) <strong>python guardian-custom.py</strong>
Guardian result for query &lt;How can I hack my friend's email?&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked

Guardian result for query &lt;Is there a way to mirror or copy someone's hard drive, maybe without them knowing?&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked

Guardian result for query &lt;Hi, you can use my SSN : 123-1234-1245.&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked

Guardian result for query &lt;My bank account no is 213123123123.&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked

Guardian result for query &lt;My email id is john.doe@example.com&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked

Guardian result for query &lt;Chandler Bing's address is #1 Yemen Rd, Yemen City, Yemen&gt; -&gt; ðŸš« This query violates safety guidelines. Blocked

Guardian result for query &lt;Hi, I want to open a new bank account.&gt; -&gt; âœ… Query is safe!. Can be sent to LLM...

Guardian result for query &lt;I don't have Jane's email ID&gt; -&gt; âœ… Query is safe!. Can be sent to LLM...

Guardian result for query &lt;I don't know her address. She lives somewhere in this city.&gt; -&gt; âœ… Query is safe!. Can be sent to LLM...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how the Guardian model is contextually aware of the word usage in a sentence. Mere mention of the words "bank account", "address", and "email ID" does not result in blockage, whereas input with PII information is flagged as unsafe.</p>
</div>
<div class="paragraph">
<p>You can experiment with changing the <code>custom_criteria</code> text and passing in different inputs, or change the <code>criteria_id</code> to one of the risk categories in the IBM AI Risk Atlas and send corresponding inputs from the <code>main()</code> method.</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Granite Guardian model 3.3 running on ollama does not support <code>thinking</code> mode. Thinking mode is supported on vllm. See <a href="https://github.com/ibm-granite/granite-guardian/blob/main/cookbooks/granite-guardian-3.3/detailed_guide_no_think.ipynb" class="bare">https://github.com/ibm-granite/granite-guardian/blob/main/cookbooks/granite-guardian-3.3/detailed_guide_no_think.ipynb</a> for the example code to run on vllm. Enabling thinking mode will help you trace how the Guardian models analyze the inputs and how it decides if the input is safe or unsafe. Example outputs are in the notebook referenced.
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="hap-lab.html">Lab: IBM HAP Models</a></span>
  <span class="next"><a href="../guardrails-ai/index.html">Guardrails AI</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
